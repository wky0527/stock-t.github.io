<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>A股做T计算器（整数股最终版）</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        label { display: block; margin-top: 10px; }
        input { padding: 5px; margin-top: 5px; width: 200px; }
        button { margin-top: 15px; padding: 8px 15px; }
        table { border-collapse: collapse; margin-top: 20px; width: 100%; }
        table, th, td { border: 1px solid #aaa; }
        th, td { padding: 8px; text-align: center; }
        h2 { margin-top: 30px; }
        .green { background-color: #d4f4dd; }
        .red { background-color: #f4d4d4; }
        input[type=range] { width: 300px; margin-top: 5px; }
        #tFeasibility { font-weight: bold; margin-top: 10px; }
        #smartTip { font-weight: bold; margin-top: 5px; display:block;}
        #bestRangeTip { margin-left:10px; color:blue; font-weight:bold;}
    </style>
</head>
<body>

<h1>A股做T计算器（整数股最终版）</h1>

<!-- 基础输入 -->
<label>持仓股数: <input type="number" id="holdShares" value="2300" step="100" oninput="updateAll()"></label>
<label>持仓成本价(元): <input type="number" step="0.01" id="costPrice" value="18.137" oninput="updateAll()"></label>
<label>当前股价(元): <input type="number" step="0.01" id="currentPrice" value="15.640" oninput="updateAll()"></label>
<div id="tFeasibility"></div>

<!-- 自定义股数做T -->
<h2>自定义股数做T（滑动条 + 自动优化买回价）</h2>
<label>卖出股数: <span id="sellSharesLabel">500</span>
    <input type="range" id="smartSellShares" min="100" max="2300" value="500" step="100" oninput="updateSmartBuyPrice()">
    <span id="bestRangeTip"></span>
</label>
<label>卖出价格(元): <span id="sellPriceLabel">15.100</span>
    <input type="range" id="smartSellPrice" min="0" max="50" step="0.01" value="15.100" oninput="updateSmartBuyPrice()">
</label>
<label>买回价格(元): <input type="number" step="0.001" id="smartBuyPrice" value="" oninput="updateSmartTProfit()"></label>
<label id="smartTip"></label>
<button onclick="calcSmartT()">计算自定义股数做T</button>

<!-- 自定义比例做T -->
<h2>自定义比例做T</h2>
<label>卖出比例（%）: <input type="number" id="customPercent" value="20"></label>
<label>卖出价格(元): <input type="number" step="0.01" id="percentSellPrice" value="15.100"></label>
<label>买回价格(元): <input type="number" step="0.01" id="percentBuyPrice" value="14.800"></label>
<button onclick="calcPercentT()">计算自定义比例做T</button>

<!-- 自动最优模式 -->
<h2>自动最优模式</h2>
<button onclick="calcAutoT()">自动最优做T（默认30%仓位，±0.3元差价）</button>
<button onclick="calcMaxProfitT()">一键最大化净收益做T</button>

<!-- 结果对比表 -->
<h2>结果对比</h2>
<table>
    <thead>
    <tr>
        <th>模式</th>
        <th>卖出股数</th>
        <th>卖出价格</th>
        <th>卖出净额</th>
        <th>买回股数</th>
        <th>买回价格</th>
        <th>买回总额</th>
        <th>新成本价</th>
        <th>净收益</th>
        <th>补仓回本价</th>
    </tr>
    </thead>
    <tbody>
    <tr id="rowAuto"><td>自动最优做T</td><td colspan="9">等待计算</td></tr>
    <tr id="rowCustom"><td>自定义股数做T</td><td colspan="9">等待计算</td></tr>
    <tr id="rowPercent"><td>自定义比例做T</td><td colspan="9">等待计算</td></tr>
    <tr id="rowMaxProfit"><td>最大净收益做T</td><td colspan="9">等待计算</td></tr>
    </tbody>
</table>

<script>
    const feeRate = 0.00023;
    const taxRate = 0.0005;

    function toIntegerShares(shares){
        return Math.floor(shares/100)*100; //取整到100股
    }

    function doT(sellShares, sellPrice, buyPrice, holdShares, costPrice){
        sellShares = toIntegerShares(sellShares);
        const sellAmount = sellShares * sellPrice;
        const sellFee = sellAmount * feeRate;
        const sellTax = sellAmount * taxRate;
        const sellNet = sellAmount - sellFee - sellTax;

        const buyAmount = sellShares * buyPrice;
        const buyFee = buyAmount * feeRate;
        const buyTotal = buyAmount + buyFee;

        const totalCostBefore = holdShares * costPrice;
        const totalCostAfter = totalCostBefore - sellNet + buyTotal;
        const newCostPrice = totalCostAfter / holdShares;

        const profit = sellNet - buyTotal;
        const breakEvenPrice = totalCostAfter / holdShares;

        return { sellShares, sellPrice, sellNet, buyShares: sellShares, buyPrice, buyTotal, newCostPrice, profit, breakEvenPrice };
    }

    function calcAutoT(){
        const holdShares = +document.getElementById("holdShares").value;
        const costPrice = +document.getElementById("costPrice").value;
        const currentPrice = +document.getElementById("currentPrice").value;

        let sellShares = toIntegerShares(Math.floor(holdShares * 0.3));
        const sellPrice = currentPrice + 0.15;
        const buyPrice = currentPrice - 0.15;

        const res = doT(sellShares, sellPrice, buyPrice, holdShares, costPrice);
        updateTable("rowAuto", res);
    }

    function checkTFeasibility(){
        const holdShares = +document.getElementById("holdShares").value;
        const costPrice = +document.getElementById("costPrice").value;
        const currentPrice = +document.getElementById("currentPrice").value;

        let sellShares = toIntegerShares(Math.floor(holdShares * 0.3));
        const sellPrice = currentPrice;
        const buyPrice = currentPrice - 0.3;

        const sellAmount = sellShares * sellPrice;
        const sellFee = sellAmount * feeRate;
        const sellTax = sellAmount * taxRate;
        const sellNet = sellAmount - sellFee - sellTax;

        const buyAmount = sellShares * buyPrice;
        const buyFee = buyAmount * feeRate;
        const buyTotal = buyAmount + buyFee;

        const profit = sellNet - buyTotal;
        const tipEl = document.getElementById("tFeasibility");

        if(profit > 0){
            tipEl.style.color = "green";
            tipEl.innerText = `当前条件适合做T，预计净收益 ${profit.toFixed(2)} 元`;
        } else {
            tipEl.style.color = "red";
            tipEl.innerText = `当前条件不适合做T，可能亏损 ${profit.toFixed(2)} 元`;
        }
    }

    function updateSmartBuyPrice(){
        const holdShares = +document.getElementById("holdShares").value;
        const costPrice = +document.getElementById("costPrice").value;
        let sellShares = toIntegerShares(+document.getElementById("smartSellShares").value);
        const sellPrice = +document.getElementById("smartSellPrice").value;

        document.getElementById("sellSharesLabel").innerText = sellShares;
        document.getElementById("sellPriceLabel").innerText = parseFloat(sellPrice).toFixed(2);

        if(!sellShares || !sellPrice){
            document.getElementById("smartBuyPrice").value = "";
            return;
        }

        const sellAmount = sellShares * sellPrice;
        const sellFee = sellAmount * feeRate;
        const sellTax = sellAmount * taxRate;
        const sellNet = sellAmount - sellFee - sellTax;

        const totalCostBefore = holdShares * costPrice;
        let buyPrice = (totalCostBefore - sellNet)/sellShares;
        const maxBuyPrice = sellPrice*0.999;
        if(buyPrice > maxBuyPrice) buyPrice = maxBuyPrice;

        document.getElementById("smartBuyPrice").value = buyPrice.toFixed(3);
        updateSmartTProfit();
    }

    function updateSmartTProfit(){
        const holdShares = +document.getElementById("holdShares").value;
        const costPrice = +document.getElementById("costPrice").value;
        const sellShares = toIntegerShares(+document.getElementById("smartSellShares").value);
        const sellPrice = +document.getElementById("smartSellPrice").value;
        const buyPrice = +document.getElementById("smartBuyPrice").value;
        const tipEl = document.getElementById("smartTip");

        if(!sellShares || !sellPrice || !buyPrice) return;

        const res = doT(sellShares, sellPrice, buyPrice, holdShares, costPrice);

        if(res.profit < 0){
            tipEl.style.color = "red";
            tipEl.innerText = `亏损警告：当前买回价会亏损，净收益 ${res.profit.toFixed(2)} 元`;
        } else {
            tipEl.style.color = "green";
            tipEl.innerText = `收益良好：净收益 ${res.profit.toFixed(2)} 元`;
        }
    }

    function calcSmartT(){
        const holdShares = +document.getElementById("holdShares").value;
        const costPrice = +document.getElementById("costPrice").value;
        let sellShares = toIntegerShares(+document.getElementById("smartSellShares").value);
        const sellPrice = +document.getElementById("smartSellPrice").value;
        const buyPrice = +document.getElementById("smartBuyPrice").value;

        const res = doT(sellShares, sellPrice, buyPrice, holdShares, costPrice);
        updateTable("rowCustom", res);
    }

    function calcPercentT(){
        const holdShares = +document.getElementById("holdShares").value;
        const costPrice = +document.getElementById("costPrice").value;
        const percent = +document.getElementById("customPercent").value / 100;
        let sellShares = toIntegerShares(Math.floor(holdShares * percent));
        const sellPrice = +document.getElementById("percentSellPrice").value;
        const buyPrice = +document.getElementById("percentBuyPrice").value;

        const res = doT(sellShares, sellPrice, buyPrice, holdShares, costPrice);
        updateTable("rowPercent", res);
    }

    function calcMaxProfitT(){
        const holdShares = +document.getElementById("holdShares").value;
        const costPrice = +document.getElementById("costPrice").value;
        const currentPrice = +document.getElementById("currentPrice").value;

        let bestProfit = -Infinity;
        let bestRes = null;
        for(let sShares = 100; sShares <= holdShares; sShares += 100){
            const sellPrice = currentPrice + 0.15;
            let buyPrice = (holdShares*costPrice - (sShares*sellPrice*(1-feeRate-taxRate)))/(sShares*(1+feeRate));
            if(buyPrice > sellPrice) buyPrice = sellPrice*0.999;
            const res = doT(sShares, sellPrice, buyPrice, holdShares, costPrice);
            if(res.profit > bestProfit){
                bestProfit = res.profit;
                bestRes = res;
            }
        }
        updateTable("rowMaxProfit", bestRes);
    }

    function updateTable(rowId, res){
        document.getElementById(rowId).innerHTML = `
<td>${rowId === "rowAuto" ? "自动最优做T" : rowId==="rowCustom"?"自定义股数做T":rowId==="rowPercent"?"自定义比例做T":"最大净收益做T"}</td>
<td>${res.sellShares}</td>
<td>${res.sellPrice.toFixed(2)}</td>
<td>${res.sellNet.toFixed(2)}</td>
<td>${res.buyShares}</td>
<td>${res.buyPrice.toFixed(3)}</td>
<td>${res.buyTotal.toFixed(2)}</td>
<td>${res.newCostPrice.toFixed(3)}</td>
<td>${res.profit.toFixed(2)}</td>
<td>${res.breakEvenPrice.toFixed(3)}</td>
`;
    }

    // 最佳卖出股数范围提示
    function calcBestSellRange(){
        const holdShares = +document.getElementById("holdShares").value;
        const costPrice = +document.getElementById("costPrice").value;
        const currentPrice = +document.getElementById("currentPrice").value;

        let minSell = 100, maxSell = 0;
        for(let sShares=100; sShares<=holdShares; sShares+=100){
            const sellAmount = sShares*currentPrice;
            const sellFee = sellAmount*feeRate;
            const sellTax = sellAmount*taxRate;
            const sellNet = sellAmount - sellFee - sellTax;

            let buyPrice = (holdShares*costPrice - sellNet)/sShares;
            const buyAmount = sShares*buyPrice;
            const buyFee = buyAmount*feeRate;
            const profit = sellNet - (buyAmount + buyFee);

            if(profit > 0){
                if(minSell===100) minSell = sShares;
                maxSell = sShares;
            }
        }

        if(maxSell===0){
            document.getElementById("bestRangeTip").innerText = "当前条件下无法做T产生正收益";
        } else {
            document.getElementById("bestRangeTip").innerText = `最佳卖出股数范围：${minSell} ~ ${maxSell}`;
        }
    }

    function updateAll(){
        const holdShares = +document.getElementById("holdShares").value;
        const sellSlider = document.getElementById("smartSellShares");
        sellSlider.max = holdShares;
        if(+sellSlider.value > holdShares) sellSlider.value = holdShares;

        updateSmartBuyPrice();
        checkTFeasibility();
        calcBestSellRange();
    }

    updateAll();
</script>

</body>
</html>
