<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½åšTæˆæœ¬è®¡ç®—å™¨ï¼ˆåŠ¨æ€è¡¥å›è‚¡ä»·ï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body style="font-family:Arial; margin:20px;">
<h2>æ™ºèƒ½åšTæˆæœ¬è®¡ç®—å™¨ï¼ˆåŠ¨æ€è¡¥å›è‚¡ä»·ï¼‰</h2>

<label>æŒä»“è‚¡æ•°: <input id="holdShares" type="number" value="2300"></label><br><br>
<label>æˆæœ¬ä»·(å…ƒ): <input id="costPrice" type="number" step="0.001" value="18.137"></label><br><br>

<h3>ä»Šæ—¥å–å‡ºè®°å½•ï¼ˆå¯å¤šæ¡ï¼‰</h3>
<div id="sellRecords">
    <div>
        å–å‡ºè‚¡æ•°: <input class="sellShares" type="number" value="500">
        å–å‡ºä»·: <input class="sellPrice" type="number" step="0.001" value="15.09">
    </div>
    <div>
        å–å‡ºè‚¡æ•°: <input class="sellShares" type="number" value="500">
        å–å‡ºä»·: <input class="sellPrice" type="number" step="0.001" value="15.10">
    </div>
</div>
<button onclick="addSellRow()">å¢åŠ å–å‡ºè®°å½•</button><br><br>

<label>ç›®æ ‡å·®ä»·(å…ƒ/è‚¡): <input id="targetDiff" type="number" step="0.01" value="0.5"></label><br><br>

<h3>æ‰‹ç»­è´¹è®¾ç½®</h3>
<label>ä½£é‡‘ç‡(ä¸‡åˆ†ä¹‹): <input id="commissionRate" type="number" step="0.01" value="2.3"></label><br>
<label>å°èŠ±ç¨ç‡(ä¸‡åˆ†ä¹‹, å–å‡ºæ”¶): <input id="stampRate" type="number" step="0.01" value="5"></label><br>
<label>æœ€ä½ä½£é‡‘(å…ƒ): <input id="minCommission" type="number" step="0.1" value="5"></label><br><br>

<h3>å‰©ä½™æŒä»“è‚¡æ•°ï¼ˆç”¨äºè¡¥å›è®¡ç®—ï¼‰: <input id="remainingShares" type="number" value="1300"></h3>

<button onclick="calculate()">è®¡ç®—æˆæœ¬å˜åŒ–</button>
<button onclick="resetChart()">é‡ç½®å›¾è¡¨</button>

<h3>ç»“æœï¼š</h3>
<div id="result" style="white-space:pre-line; font-size:16px; color:#333;"></div>

<h3>æˆæœ¬å˜åŒ–å›¾ï¼š</h3>
<canvas id="costChart" width="700" height="350"></canvas>

<script>
    let costHistory = [];
    let chart;

    function initChart(initialCost){
        const ctx = document.getElementById('costChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ["åˆå§‹æˆæœ¬"],
                datasets: [{
                    label: 'æŒä»“æˆæœ¬å˜åŒ–',
                    data: [initialCost],
                    borderColor: 'blue',
                    backgroundColor: 'lightblue',
                    fill: false,
                    tension: 0.1
                }]
            },
            options:{ responsive:false, scales:{ y:{ beginAtZero:false } } }
        });
        costHistory = [initialCost];
    }

    function addSellRow(){
        const div = document.createElement("div");
        div.innerHTML = 'å–å‡ºè‚¡æ•°: <input class="sellShares" type="number" value="0">  å–å‡ºä»·: <input class="sellPrice" type="number" step="0.001" value="0">';
        document.getElementById("sellRecords").appendChild(div);
    }

    // æ‰‹ç»­è´¹è®¡ç®—
    function calcFee(amount, isSell, commissionRate, stampRate, minCommission){
        let fee = amount * commissionRate / 10000;
        if(fee < minCommission) fee = minCommission;
        if(isSell) fee += amount * stampRate / 10000;
        return fee;
    }

    function calculate(){
        let holdShares = parseFloat(document.getElementById("holdShares").value);
        let costPrice = parseFloat(document.getElementById("costPrice").value);
        let targetDiff = parseFloat(document.getElementById("targetDiff").value);
        let commissionRate = parseFloat(document.getElementById("commissionRate").value);
        let stampRate = parseFloat(document.getElementById("stampRate").value);
        let minCommission = parseFloat(document.getElementById("minCommission").value);
        let remainingShares = parseFloat(document.getElementById("remainingShares").value);

        // å–å‡ºè®°å½•
        let sellSharesInputs = document.querySelectorAll(".sellShares");
        let sellPriceInputs = document.querySelectorAll(".sellPrice");
        let totalSellNet = 0;
        let totalSellShares = 0;
        let resultText = "";

        for(let i=0;i<sellSharesInputs.length;i++){
            let s = parseFloat(sellSharesInputs[i].value);
            let p = parseFloat(sellPriceInputs[i].value);
            if(s<=0) continue;
            let amount = s*p;
            let fee = calcFee(amount,true,commissionRate,stampRate,minCommission);
            let net = amount - fee;
            totalSellNet += net;
            totalSellShares += s;

            resultText += `å–å‡º${s}è‚¡, å–å‡ºä»·${p}, æ‰‹ç»­è´¹${fee.toFixed(2)}, å–å‡ºå‡€é¢${net.toFixed(2)}\n`;
        }

        if(totalSellShares === 0){
            alert("è¯·å¡«å†™æœ‰æ•ˆå–å‡ºè®°å½•ï¼");
            return;
        }

        // è‡ªåŠ¨è®¡ç®—ä¸‹ä¸€æ­¥ä¹°å…¥ä»·æ ¼å’Œè‚¡æ•°
        let buyPrice = 0;
        let count = 0;
        for(let i=0;i<sellPriceInputs.length;i++){
            let p = parseFloat(sellPriceInputs[i].value);
            let s = parseFloat(sellSharesInputs[i].value);
            if(s>0){
                buyPrice += p - targetDiff;
                count++;
            }
        }
        buyPrice = buyPrice / count;

        let buyShares = totalSellShares;
        let buyAmount = buyShares*buyPrice;
        let buyFee = calcFee(buyAmount,false,commissionRate,0,minCommission);
        let buyNet = buyAmount + buyFee;

        resultText += `\nå»ºè®®ä¹°å…¥${buyShares}è‚¡, ä¹°å…¥ä»·çº¦${buyPrice.toFixed(2)}, æ‰‹ç»­è´¹${buyFee.toFixed(2)}, ä¹°å…¥å‡€æ”¯å‡º${buyNet.toFixed(2)}\n`;

        let netProfit = totalSellNet - buyNet;

        // æ–°æˆæœ¬ä»·
        let newCost = (costPrice*holdShares - netProfit)/holdShares;
        let floating = (buyPrice - newCost)*holdShares;

        resultText += `\næœ¬æ¬¡å‡€æ”¶ç›Š: ${netProfit.toFixed(2)} å…ƒ\næ–°çš„æŒä»“æˆæœ¬: ${newCost.toFixed(3)} å…ƒ\nå½“å‰æµ®äº/æµ®ç›ˆ: ${floating.toFixed(2)} å…ƒ`;

        // ğŸ”¹åŠ¨æ€è®¡ç®—å‰©ä½™æŒä»“è¡¥å›è‚¡ä»·
        if(remainingShares>0){
            let requiredPrice = (netProfit/remainingShares) + costPrice;
            resultText += `\nå¦‚æœä¸ä¹°å›ï¼Œå‰©ä½™${remainingShares}è‚¡éœ€è¦è‚¡ä»·æ¶¨åˆ°çº¦${requiredPrice.toFixed(2)}å…ƒæ‰èƒ½å¼¥è¡¥ä»Šæ—¥å–å‡ºå·®ä»·`;
        }

        document.getElementById("result").innerText = resultText;

        // æ›´æ–°å›¾è¡¨
        costHistory.push(newCost);
        chart.data.labels.push("ä¹°å›å");
        chart.data.datasets[0].data.push(newCost);
        chart.update();

        document.getElementById("costPrice").value = newCost.toFixed(3);
    }

    function resetChart(){
        let initCost = parseFloat(document.getElementById("costPrice").value);
        chart.destroy();
        initChart(initCost);
    }

    window.onload = function(){
        let initCost = parseFloat(document.getElementById("costPrice").value);
        initChart(initCost);
    }
</script>
</body>
</html>
